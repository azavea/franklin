Parameters:
  App:
    Type: String
    Description: Your application's name.
  Env:
    Type: String
    Description: The environment name your service, job, or workflow is being deployed to.
  Name:
    Type: String
    Description: The name of the service, job, or workflow being deployed.
  IpWhiteList:
    Type: String
    Description: A comma delimited list of IPs to allow add, update, delete actions

Resources:
  HTTPSListenerRuleAllowCUDByIp:
    Type: AWS::ElasticLoadBalancingV2::ListenerRule
    Properties:
      Actions:
        - TargetGroupArn: !Sub '${App}-${Env}-DefaultHTTPTargetGroup'
          Type: forward
      Conditions:
        - Field: 'source-ip'
          SourceIpConfig:
            Values:
              - 66.212.12.106/32
        - Field: 'http-request-method'
          HttpRequestMethodConfig:
            Values:
              - POST
              - PUT
              - DELETE
      ListenerArn:
        Fn::ImportValue: !Sub '${App}-${Env}-HTTPSListenerArn'
      Priority: 5000
  HTTPSListenerRuleBlockCUD:
    Type: AWS::ElasticLoadBalancingV2::ListenerRule
    Properties:
      Actions:
        - Type: 'fixed-response'
          FixedResponseConfig:
            ContentType: 'text/plain'
            MessageBody: Not allowed to access this resource
            StatusCode: '403'
      Conditions:
        - Field: 'http-request-method'
          HttpRequestMethodConfig:
            Values:
              - POST
              - PUT
              - DELETE
      ListenerArn:
        Fn::ImportValue: !Sub '${App}-${Env}-HTTPSListenerArn'
      Priority: 4999

Outputs:
  HTTPSListenerRuleBlockCUD:
    Value: !Ref HTTPSListenerRuleBlockCUD
  HTTPSListenerRuleAllowCUDByIp:
    Value: !Ref HTTPSListenerRuleAllowCUDByIp